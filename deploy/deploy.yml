---
- hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - env_vars/base.yml
    - env_vars/base-vault.yml

  roles:
    - provision-database
    - create-ami-builder

- name: Configure instance to create AMI
  hosts: amibuilder
  gather_facts: false

  become: yes
  become_user: root
  remote_user: ubuntu

  vars_files:
    - env_vars/base.yml
    - env_vars/base-vault.yml

  pre_tasks:
    - name: Install python 2
      become: yes
      become_user: root
      remote_user: ubuntu
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      register: output
      changed_when: output.stdout != ""
      until: output.rc == 0
      retries: 3
      delay: 1
    - name: Restore database instance reference
      set_fact:
        db_instance: "{{ hostvars['localhost'].db_instance }}"

  roles:
    - cdriehuys.django-app
    - cdriehuys.nginx

- name: Finalize AMI
  hosts: localhost
  connection: local

  vars_files:
    - env_vars/base.yml

  roles:
    - finalize-ami
